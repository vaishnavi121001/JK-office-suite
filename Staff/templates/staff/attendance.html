{% extends 'staff/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h3 class="mb-4">üì∑ Upload QR Code to Mark Attendance</h3>

    <!-- Clock Display -->
    <div class="text-muted mb-3">
        <strong>Current Time:</strong> <span id="clock" class="fw-bold text-primary"></span>
    </div>

    <form id="qrUploadForm" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
            <label for="qrImage" class="form-label fw-bold">Upload QR Code Image</label>
            <input type="file" class="form-control" id="qrImage" accept="image/*" required>
        </div>
        <button type="submit" class="btn btn-primary">Mark Attendance ‚úÖ</button>
    </form>

    <div id="responseMessage" class="mt-3"></div>

    <hr>

    <h5 class="mt-5">üìÖ Attendance History</h5>
    <div class="table-responsive">
        <table class="table table-bordered table-striped mt-3">
    <thead class="table-dark">
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Logout Time</th>  <!-- New column -->
        </tr>
    </thead>
    <tbody id="attendanceTable">
        {% for record in attendance_records %}
        <tr>
            <td>{{ record.date }}</td>
            <td>{{ record.created_at|time:"H:i:s" }}</td>
            <td>{{ record.status }}</td>
            <td>
    {% if record.logout_time %}
        {{ record.logout_time|time:"H:i:s" }}
    {% else %}
        Not Logged Out
    {% endif %}
</td>

        </tr>
        {% empty %}
        <tr class="text-center">
            <td colspan="4">No attendance records yet.</td>  <!-- Adjusted colspan -->
        </tr>
        {% endfor %}
    </tbody>
</table>

    </div>
</div>

<!-- JSQR for QR decoding -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
// Live clock
function updateClock() {
    const now = new Date();
    const options = {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    };
    const timeString = now.toLocaleString('en-US', options);
    document.getElementById('clock').textContent = timeString;
}
setInterval(updateClock, 1000);
updateClock();

// QR code form handling
document.getElementById('qrUploadForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const fileInput = document.getElementById('qrImage');
    const file = fileInput.files[0];
    const messageDiv = document.getElementById("responseMessage");

    if (!file) {
        alert("Please upload an image.");
        return;
    }

    const reader = new FileReader();
    reader.onload = async function () {
        const img = new Image();
        img.onload = async function () {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);

            if (code) {
                try {
                    const data = JSON.parse(code.data);
                    const response = await fetch("{% url 'mark_attendance' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": '{{ csrf_token }}',
                        },
                        body: JSON.stringify({
                            username: data.username,
                            secret_key: data.secret_key
                        })
                    });

                    const result = await response.json();
                    messageDiv.innerHTML =
                        `<div class="alert ${result.success ? 'alert-success' : 'alert-danger'}">${result.message}</div>`;

                    if (result.success) {
                        // Remove "No records yet" row if present
                        document.querySelector("#attendanceTable .text-center")?.remove();

                        const currentTime = new Date();
                        const formattedDate = currentTime.toLocaleDateString();
                        const formattedTime = currentTime.toLocaleTimeString();
                        const row = `
                            <tr>
                                <td>${formattedDate}</td>
                                <td>${formattedTime}</td>
                                <td>Present</td>
                            </tr>`;
                        document.getElementById("attendanceTable").insertAdjacentHTML('afterbegin', row);
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error processing QR. Please try again.</div>`;
                }
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">‚ùå Unable to read QR code. Please upload a valid one.</div>`;
            }
        };
        img.src = reader.result;
    };
    reader.readAsDataURL(file);
});
</script>
{% endblock %}